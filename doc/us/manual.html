<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <title>The Xavante Lua Web Server Manual</title>
    <link rel="stylesheet" href="http://www.keplerproject.org/doc.css" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
</head>

<body>

<div id="container">

<div id="product">
	<div id="product_logo"><a href="http://www.keplerproject.org">
		<img alt="Xavante logo" src="xavante.gif"/>
	</a></div>
	<div id="product_name"><big><strong>Xavante</strong></big></div>
	<div id="product_description">A Lua Web Server with CGILua support</div>
</div> <!-- id="product" -->

<div id="main">

<div id="navigation">
<h1>Xavante</h1>
	<ul>
		<li><a href="index.html">Home</a>
            <ul>
              <li><a href="index.html#over">Overview</a></li>
              <li><a href="index.html#status">Status</a></li>
              <li><a href="index.html#download">Download</a></li>
              <li><a href="index.html#history">History</a></li>
              <li><a href="index.html#components">Dependencies</a></li>
              <li><a href="index.html#portability">Portability</a></li>
              <li><a href="index.html#credits">Credits</a></li>
              <li><a href="index.html#contact">Contact us</a></li>
            </ul>
        </li>
		<li><strong>Manual</strong>
            <ul>
              <li><a href="manual.html#install">Installing</a></li>
              <li><a href="manual.html#config">Configuring</a></li>
              <li><a href="manual.html#running">Running</a></li>
            </ul>
        </li>
        <li><a href="sajax.html">Sajax</a></li>
        <li><a href="license.html">License</a></li>
		<li><a href="http://luaforge.net/projects/xavante/">LuaForge project</a></li>
	</ul>
</div> <!-- id="navigation" -->

<div id="content">

<h2><a name="install"></a>Installing</h2>

<p>Xavante follows the
<a href="http://www.keplerproject.org/compat/">package model</a>
for Lua 5.1, therefore it should be "installed". Refer to
<a href="http://www.keplerproject.org/compat/manual.html#configuration">
Compat-5.1 configuration</a> section about how to install the modules properly.</p>

<p>Windows users can use the pre-compiled version of Xavante's binary components
(LuaFileSystem and LuaSocket) available at <a href="http://luaforge.net">LuaForge</a>.</p>

<p>Xavante installation is very flexible and is based on three directories:</p>

<p><code>$LIB</code> - Lua binary libraries</p>

<p><code>$LUA</code> - Lua libraries</p>

<p><code>$WEB</code> - Xavante HTTP documents.</p>

<p>For convenience, those directories can be under the same home directory as the following
examples show.</p>

<p>The Xavante source includes a file <code>t_xavante_start.lua</code>. This is
a template for the Xavante startup file. You must edit it so it reflects your system Lua paths
and then rename it to <code>xavante_start.lua</code>.</p>

<h3>Windows Installation Example</h3>

<p>An example of a Windows LuaBinaries compatible Xavante installation is the one used by
<a href="http://www.keplerproject.org/">Kepler</a>. It is shown below with the list of
included files and where those files can be
found in <a href="http://luaforge.net">LuaForge</a>.</p>

<p>For each of the projects downloaded from LuaForge, you'll have to copy the source files to
the corresponding directory below. Note that sometimes the LuaForge download may include a
somewhat different name for the directory.</p>

<pre class="example">
$HOME
    lua50.dll             -- <a href="http://luaforge.net/projects/luabinaries/files">LuaBinaries</a>
    lua50.exe             -- LuaBinaries
    xavante_start.lua     -- Xavante (t_xavante_start.lua)
    
    $LIB
        lfs.dll           -- <a href="http://luaforge.net/projects/luafilesystem/files">LuaFileSystem</a>
        lmime.dll         -- <a href="http://luaforge.net/projects/luasocket/files">LuaSocket</a>
        lsocket.dll       -- LuaSocket
    
    $LUA
        compat-5.1.lua    -- <a href="http://luaforge.net/projects/compat/files">Compat</a>
        ltn12.lua         -- LuaSocket
        mime.lua          -- LuaSocket
        stable.lua        -- <a href="http://luaforge.net/projects/venv/files">VEnv</a>
        venv.lua          -- VEnv
        /cgilua           -- <a href="http://luaforge.net/projects/cgilua/files">CGILua</a>
            ...        
        /copas            -- <a href="http://luaforge.net/projects/copas/files">Copas</a>
            ...
        /coxpcall         -- Xavante
            coxpcall.lua
        /sajax            -- Xavante
            sajax.lua
        /socket           -- LuaSocket
            ...
        /xavante          -- Xavante
            ...
    
    $CONF
        /cgilua
          config.lua      -- CGILua
        /xavante
          config.lua      -- Xavante
        
    $WEB
        index.lp          -- Xavante
        test.lp           -- Xavante
        /doc              -- Xavante (doc/us)
            ...
        /img              -- Xavante
            ...
</pre>

<p>Note that the Kepler installation creates a separate directory for
configuration files (<code>$CONF</code>) and adjusts <code>LUA_PATH</code>
accordingly to make sure that the files present on <code>$CONF</code>
are found first. That allows the upgrade of Xavante and other components
without overwriting the user configuration.</p>

<p>Also note that the <code>LUA_PATH</code> can also include other directories
in order to allow Xavante configuration to be determined for each user for
example.</p>

<p>The example below shows the startup file <code>xavante_start.lua</code>
for a Kepler Windows installation on <code>c:\kepler</code>.</p>

<pre class="example">
--- compatibility code for Lua version 5.0 providing 5.1 behavior
if string.find (_VERSION, "Lua 5.0") and not _COMPAT51 then
  if not LUA_PATH then
    LUA_PATH = "c:/kepler/conf/?.lua;"..
               "c:/kepler/lua/?.lua;"..
               "c:/kepler/lua/?/?.lua;"..
               "c:/kepler/lua/?/init.lua;"
  end
  require"compat-5.1"
  package.cpath = "c:/kepler/lib/?.dll"
end

require "xavante.server"
xavante.start(XAVANTE_ISFINISHED, XAVANTE_TIMEOUT)
</pre>

<h3>Linux Installation Example</h3>

<p>And example of a Linux Xavante installation is the one used by Kepler. It puts the
<code>$HOME</code> directory at <code>/usr/local/kepler</code>,
the <code>$LIB</code> directory at <code>/usr/local/lib/lua/5.0</code>,
with a symbolic link at <code>$HOME/lib</code>, the <code>$LUA</code> directory at
<code>/usr/local/share/lua/5.0</code>, with a symbolic link at <code>$HOME/lua</code>.
It also assumes that the Lua executable, the Lua Library and <code>xavante_start.lua</code>
are located in the system path (usually <code>/usr/local/bin</code>).</p>

<p>The Linux Makefile uses <code>sed</code> to build a <code>xavante_start.lua</code>
that conforms to the above Kepler installation directories.</p>

<p>The Linux Xavante installation would differ only in the contents of
the <code>$LIB</code> directories</p>

<pre class="example">
$HOME
    $LIB
        lfs.so
        lmime.so
        lsocket.so
</pre>

<p>and in the definition of the paths in <code>xavante_start.lua</code>:</p>

<pre class="example">
--- compatibility code for Lua version 5.0 providing 5.1 behavior
if string.find (_VERSION, "Lua 5.0") and not _COMPAT51 then
  if not LUA_PATH then
    LUA_PATH = "/usr/local/kepler/conf/?.lua;"..
               "/usr/local/share/lua/5.0/?.lua;"..
               "/usr/local/share/lua/5.0/?/?.lua;"..
               "/usr/local/share/lua/5.0/?/init.lua;"
  end

  require"compat-5.1"
  package.cpath = "/usr/local/lib/lua/5.0/?.so"
end

require "xavante.server"
xavante.start(XAVANTE_ISFINISHED, XAVANTE_TIMEOUT)
</pre>

<p>To install Xavante from the distribution source in a Linux enviroment, simply
edit the <code>config</code> file to use the correct paths for your system and do:</p>

<pre class="example">
make
make install
</pre>

<h2><a name="config"></a>Configuring</h2>

<p>The file <code>$LUA/xavante/config.lua</code> defines the
Xavante configuration. On the Kepler example, this file is copied to the
<code>$CONF/xavante</code> directory to make it easier to upgrade
a Xavante installation since the searching order of
<code>LUA_PATH</code> will make the command
<code>require"xavante.config"</code> find the
<code>$CONF/xavante/config.lua</code> before the
<code>$LUA/xavante/config.lua</code>.</p>

<p>Xavante defines <em>virtualhosts</em> for each site
that it is running. Each virtualhost can define a set of <em>rules</em> for it.
Each rule matches a <em>URL pattern</em> with a handler.
Xavante currently offers a <strong>file handler</strong>,
a <strong>redirect handler</strong> and
a <strong>CGILua handler</strong> for general files, URL
remapping and CGILua scripts respectively.</p>

<p>A typical Windows <code>config.lua</code> uses the format below</p>

<pre class="example">
require "xavante.filehandler"
require "xavante.cgiluahandler"
require "xavante.redirecthandler"

local simplerules = {
    -- URL remapping example
    {match = "/", with = xavante.redirecthandler,
    params = {"index.lp"}}, 
    -- filehandler example
    {match = "/*", with = xavante.filehandler,
    params = {baseDir = "c:\kepler\web"}},
    -- cgiluahandler example
    {match = {"/*.lp", "/*.lua"},
    with = xavante.cgiluahandler.makeHandler ("c:\kepler\web")},
}

xavante.HTTP{
    server = {host = "*", port = 80},
    
    defaultHost = {
    	rules = simplerules
    },
}
</pre>

<p>Note the use of <code>"c:\kepler\web"</code> both to set the base directory
for the file handler and for the CGILua scripts. This path should be edited for
the desired directory if you are not using the Kepler structure.</p>

<p>To use virtual hosts with Xavante, the call to <code>xavante.HTTP</code>
would be changed to something like</p>

<pre class="example">
xavante.HTTP{
    server = {host = "*", port = 80},
    
    defaultHost = {},
    
    virtualhosts = {
        ["www.sitename.com"] = simplerules
    }
}</pre>


<h2><a name="running"></a>Running</h2>

<p>Running Xavante requires the execution of the correctly set
<code>xavante_start.lua</code>. This can be done through a 
<code>xavante.bat</code> file in Windows, or by giving execution rights to
the <code>xavante_start.lua</code> on Linux.</p>

<p>The example below is a <code>xavante.bat</code> that can be used to start
Xavante in Windows using the same configuration as the above examples.</p>

<pre class="example">
@echo Xavante Started
@c:\kepler\lua50.exe c:\kepler\xavante_start.lua
</pre>

<p>Remember that <code>xavante_start.lua</code> is the configured version of 
<code>t_xavante_start.lua</code> and if you are <a href="#install">installing</a>
Xavante from the source files you should edit it first.</p>

<p>After Xavante is started, opening the URL
<code>http://localhost</code> on your browser should show the Xavante welcome page.
If you changed the port number on <code>config.lua</code> you should also use this
port number in the URL.</p>

<p>The welcome page presents the Xavante version and links to the documentation and
for a simple set of tests.</p>

</div> <!-- id="content" -->

</div> <!-- id="main" -->

<div id="about">
	<p><a href="http://validator.w3.org/check?uri=referer">
    <img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0!" height="31" width="88" /></a></p>
	<p><small>$Id: manual.html,v 1.31 2005/08/10 18:54:43 carregal Exp $</small></p>
</div> <!-- id="about" -->

</div> <!-- id="container" -->

</body>
</html>
