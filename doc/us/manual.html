<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <title>The Xavante Lua Web Server Manual</title>
    <link rel="stylesheet" href="http://www.keplerproject.org/doc.css" type="text/css"/>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
</head>

<body>

<div id="container">

<div id="product">
	<div id="product_logo"><a href="http://www.keplerproject.org">
		<img alt="Xavante logo" src="xavante.gif"/>
	</a></div>
	<div id="product_name"><big><strong>Xavante</strong></big></div>
	<div id="product_description">A Lua Web Server with CGILua support</div>
</div> <!-- id="product" -->

<div id="main">

<div id="navigation">
<h1>Xavante</h1>
	<ul>
		<li><a href="index.html">Home</a>
            <ul>
              <li><a href="index.html#over">Overview</a></li>
              <li><a href="index.html#status">Status</a></li>
              <li><a href="index.html#download">Download</a></li>
              <li><a href="index.html#dependencies">Dependencies</a></li>              
              <li><a href="index.html#history">History</a></li>
              <li><a href="index.html#credits">Credits</a></li>
              <li><a href="index.html#contact">Contact us</a></li>
            </ul>
        </li>
		<li><strong>Manual</strong>
            <ul>
              <li><a href="manual.html#install">Installing</a></li>
              <li><a href="manual.html#config">Configuring</a></li>
              <li><a href="manual.html#running">Running</a></li>
            </ul>
        </li>
        <li><a href="sajax.html">Sajax</a></li>
	    <li><a href="http://luaforge.net/projects/xavante/">Project</a>
	        <ul>
	            <li><a href="http://luaforge.net/tracker/?group_id=6">Bug Tracker</a></li>
	            <li><a href="http://luaforge.net/scm/?group_id=6">CVS</a></li>
	        </ul>
	    </li>
        <li><a href="license.html">License</a></li>
	</ul>
</div> <!-- id="navigation" -->

<div id="content">

<h2><a name="install"></a>Installing</h2>

<p>
Xavante follows the package model for Lua 5.1, therefore it should be "installed".
Refer to <a href="http://www.keplerproject.org/compat/manual.html#configuration">
Compat-5.1 configuration</a> section about how to install the modules properly
in a Lua 5.0 environment.
</p>

<p>
You can learn more about the Lua 5.1 package model in
<a href="http://www.inf.puc-rio.br/~roberto/pil2/chapter15.pdf">chapter 15</a>
of Programming in Lua (second edition).
</p>

<p>
Windows users can use the pre-compiled version of Xavante's binary components
(LuaSocket, LuaFileSystem and Rings) available at
<a href="http://luaforge.net">LuaForge</a>.</p>

<p>Xavante installation is very flexible and is based on three directories:</p>

<p><code>$LIB</code> - Lua binary libraries</p>

<p><code>$LUA</code> - Lua libraries</p>

<p><code>$WEB</code> - Xavante HTTP documents.</p>

<p>
The <code>$LUA</code> directory should be part of the defined Lua Path
(<code>LUA_PATH</code> in Lua 5.0, <code>package.path</code> in Lua 5.1)
and the <code>$LIB</code> directory should be part of the defined Lua CPath
(<code>LUA_CPATH</code> in Lua 5.0, <code>package.cpath</code> in Lua 5.1).
Those directories can be even under the same upper directory if this is convenient,
as the following examples show.
</p>

<p>
The Xavante source includes a file called <code>t_xavante_start.lua</code>. This is
a template for the Xavante startup file. You must edit it so it reflects your system
Lua Paths and CPaths, then rename it to <code>xavante_start.lua</code>. This file also defines
the global <code>XAVANTE_WEB</code>, corresponding to the <code>$WEB</code> directory.
</p>

<h3>Windows Installation Example</h3>

<p>
If you are using Lua 5.0, an example of a Windows LuaBinaries 5.0 Release 2
Xavante installation is the one used by
<a href="http://www.keplerproject.org/">Kepler</a>. It is shown below with the
list of included files and where those files can be found in
<a href="http://luaforge.net">LuaForge</a>.
</p>

<p>
If you are installing manually, for each of the projects downloaded from LuaForge,
you'll have to copy the source files to the corresponding directory below.
</p>

<pre class="example">
$HOME
    lua50.dll             -- <a href="http://luaforge.net/projects/luabinaries/files">LuaBinaries</a>
    lua50.exe             -- LuaBinaries
    xavante_start.lua     -- Xavante (derived from t_xavante_start.lua)
    
    $LIB
        lfs.dll           -- <a href="http://luaforge.net/projects/luafilesystem/files">LuaFileSystem</a>
        rings.dll         -- <a href="http://luaforge.net/projects/rings/files">Rings</a>
        /mime
            core.dll      -- <a href="http://luaforge.net/projects/luasocket/files">LuaSocket</a>
        /socket
            core.dll      -- LuaSocket
    
    $LUA
        compat-5.1.lua    -- <a href="http://luaforge.net/projects/compat/files">Compat</a>
        ltn12.lua         -- LuaSocket
        mime.lua          -- LuaSocket
        stable.lua        -- <a href="http://luaforge.net/projects/rings/files">Rings</a>
        /cgilua           -- <a href="http://luaforge.net/projects/cgilua/files">CGILua</a>
            ...        
        /copas            -- <a href="http://luaforge.net/projects/copas/files">Copas</a>
            copas.lua
        /coxpcall         -- Xavante
            coxpcall.lua
        /sajax            -- Xavante
            sajax.lua
        /socket           -- LuaSocket
            ...
        /xavante          -- Xavante
            ...
    
    $CONF
        /cgilua
          config.lua      -- CGILua
        /xavante
          config.lua      -- Xavante
        
    $WEB
        index.lp          -- Xavante
        test.lp           -- Xavante
        /doc              -- Xavante (doc/us)
            ...
        /img              -- Xavante
            ...
</pre>

<p>
Note that the Kepler installation creates a separate directory for
configuration files (<code>$CONF</code>) and adjusts the Lua Path
accordingly to make sure that the files present on <code>$CONF</code>
are found first. That allows the upgrade of Xavante and other components
without overwriting the user configuration.
</p>

<p>
Also note that the Lua Path can also include other directories
in order to allow a different Xavante configuration to be determined for
each user for example.
</p>

<p>
The example below shows the startup file <code>xavante_start.lua</code>
for a Kepler installation using the environment variable <code>KEPLER_INIT</code>
to define the Lua Path and CPath.
</p>

<pre class="example">
-- KEPLER_INIT points to kepler_init.lua
-- kepler_init.lua defines package.path, package.cpath and XAVANTE_WEB
dofile(os.getenv("KEPLER_INIT"))

require "xavante"
xavante.start()
</pre>

<p>
For more information on the use of <code>KEPLER_INIT</code> please check the
Kepler documentation.
</p>

<h3>Linux Installation Example</h3>

<p>An example of a Linux Xavante installation for Lua 5.0 is the one used by Kepler.
It puts the <code>$HOME</code> directory at <code>/usr/local/kepler</code>,
the <code>$LIB</code> directory at <code>/usr/local/lib/lua/5.0</code>,
with a symbolic link at <code>$HOME/lib</code>, the <code>$LUA</code> directory at
<code>/usr/local/share/lua/5.0</code>, with a symbolic link at <code>$HOME/lua</code>.
It also assumes that the Lua executable and <code>xavante_start.lua</code>
are located in the system path (usually <code>/usr/local/bin</code>).</p>

<p>The Linux Makefile uses <code>sed</code> to build a <code>xavante_start.lua</code>
that conforms to the above Kepler installation directories.</p>

<p>The Linux Xavante installation would differ basically only in the contents of
the <code>$LIB</code> directories</p>

<pre class="example">
$LIB
    lfs.so
    rings.so
    /mime
        core.so
    /socket
        core.so
</pre>

<p>
The Kepler initialization file handles the path setting, so <code>xavante_start.lua</code>
is the same one used by Windows:
</p>

<pre class="example">
-- KEPLER_INIT points to kepler_init.lua
-- kepler_init.lua defines package.path, package.cpath and XAVANTE_WEB
dofile(os.getenv("KEPLER_INIT"))

require "xavante"
xavante.start()
</pre>

<p>
To install Xavante from the distribution source in a Linux enviroment, simply
edit the <code>config</code> file to use the correct paths for your system and do:
</p>

<pre class="example">
make
make install
</pre>

<h2><a name="config"></a>Configuring</h2>

<p>
The file <code>$LUA/xavante/config.lua</code> defines the
Xavante configuration. in the Kepler example, this file is copied to the
<code>$CONF/xavante</code> directory to make it easier to upgrade
a Xavante installation since the searching order of
Lua Path will make the command
<code>require"xavante.config"</code> find the
<code>$CONF/xavante/config.lua</code> before the
<code>$LUA/xavante/config.lua</code>.
</p>

<p>
Xavante defines <em>virtualhosts</em> for each site
that it is running. Each virtualhost can define a set of <em>rules</em> for it.
Each rule matches a <em>URL pattern</em> with a handler.
Xavante currently offers a <strong>file handler</strong>,
a <strong>redirect handler</strong> and
a <strong>CGILua handler</strong> for general files, URL
remapping and CGILua scripts respectively.
</p>

<p>A typical <code>config.lua</code> uses the format below</p>

<pre class="example">
require "xavante.filehandler"
require "xavante.cgiluahandler"
require "xavante.redirecthandler"

-- Define here where HTML and CGILua scripts are located
local webDir = XAVANTE_WEB

local simplerules = {
    { -- URL remapping example
    match = "/",
    with = xavante.redirecthandler,
    params = {"index.lp"}
    }, 

    
    { -- filehandler example
    match = "/*",
    with = xavante.filehandler,
    params = {baseDir = webDir}
    },
     
    { -- cgiluahandler example
    match = {"/*.lp", "/*.lua"},
    with = xavante.cgiluahandler.makeHandler (webDir)
    },
}

xavante.start_message(function (ports)
    local date = os.date("[%Y-%m-%d %H:%M:%S]")
    print(string.format("%s Xavante started on port(s) %s",
      date, table.concat(ports, ", ")))
  end)

xavante.HTTP{
    server = {host = "*", port = 80},
    
    defaultHost = {
    	rules = simplerules
    },
}
</pre>

<p>Note the use of <code>webDir</code> both to set the base directory
for the file handler and for the CGILua scripts. This path should be edited for
the desired directory if you are not using the Kepler structure.</p>

<p>To use virtual hosts with Xavante, the call to <code>xavante.HTTP</code>
would be changed to something like</p>

<pre class="example">
xavante.HTTP{
    server = {host = "*", port = 80},
    
    defaultHost = {},
    
    virtualhosts = {
        ["www.sitename.com"] = simplerules
    }
}</pre>


<h2><a name="running"></a>Running</h2>

<p>
Running Xavante requires the execution of the correctly set
<code>xavante_start.lua</code>. This can be done through a 
<code>xavante.bat</code> file in Windows, or by giving execution rights to
the <code>xavante_start.lua</code> on Linux.
</p>

<p>
The example below is a <code>xavante.bat</code> that can be used to start
Xavante on Windows using the same configuration as the above examples.
</p>

<pre class="example">
@c:\kepler\lua50.exe c:\kepler\xavante_start.lua
</pre>

<p>
Remember that <code>xavante_start.lua</code> is the configured version of 
<code>t_xavante_start.lua</code> and if you are <a href="#install">installing</a>
Xavante from the source files you should edit it first.
</p>

<p>
After Xavante is started, opening the URL
<code>http://localhost</code> on your browser should show the Xavante welcome page.
If you changed the port number on <code>config.lua</code> you should also use this
port number in the URL.
</p>

<p>
The welcome page presents the Xavante version and links to the documentation and
to a simple set of tests.
</p>

<p>
As a final note, if you start Xavante like this example showed, you will have to
kill the process to stop Xavante since there is no "<code>xavante_stop.lua</code>".
Kepler offers an easier way to handle Xavante in Windows by using a Xavante tray bar
control.
</p>

</div> <!-- id="content" -->

</div> <!-- id="main" -->

<div id="about">
	<p><a href="http://validator.w3.org/check?uri=referer">
    <img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0!" height="31" width="88" /></a></p>
	<p><small>$Id: manual.html,v 1.37 2006/08/11 19:29:30 carregal Exp $</small></p>
</div> <!-- id="about" -->

</div> <!-- id="container" -->

</body>
</html>
